<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="app-bg">

    <header class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom header-glass">
        <div class="d-flex align-items-center">
            <a href="{{ url_for('main') }}" class="btn btn-outline-secondary btn-sm me-2">&larr; Back</a>
            <h5 class="mb-0">
                Chat with {{ other_user.full_name if other_user else 'User ' ~ other_id }}
            </h5>
        </div>
    </header>

    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-12 col-md-8">
                <div class="panel p-3 d-flex flex-column" style="height: 70vh;">
                    <div id="messages" class="flex-grow-1 mb-3 overflow-auto border rounded p-2 bg-white">
                        {% for m in messages %}
                        <div class="mb-2 text-{{ 'end' if m.from_id == current_user_id else 'start' }}">
                            <span class="badge bg-{{ 'primary' if m.from_id == current_user_id else 'secondary' }}">
                                {{ m.text }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>

                    <form id="chatForm" class="d-flex gap-2">
                        <input type="text" id="chatInput" class="form-control" placeholder="Type a message..."
                            autocomplete="off">
                        <button class="btn btn-primary" type="submit">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
    <script>
        const socket = io();

        const CURRENT_USER_ID = {{ current_user_id| tojson }};
        const OTHER_ID = {{ other_id| tojson }};

        const messagesDiv = document.getElementById('messages');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');

        // Join room for this conversation
        socket.emit('join', { other_id: OTHER_ID });

        // Load history
        socket.on('history', function (history) {
            history.forEach(addMessage);
            scrollToBottom();
        });

        // Receive new messages
        socket.on('new_message', function (msg) {
            addMessage(msg);
            scrollToBottom();
        });

        chatForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (!text) return;

            socket.emit('send_message', {
                other_id: OTHER_ID,
                text: text
            });

            chatInput.value = '';
        });

        function addMessage(msg) {
            const div = document.createElement('div');
            div.className = 'mb-2 text-' + (msg.from_id === CURRENT_USER_ID ? 'end' : 'start');

            const span = document.createElement('span');
            span.className = 'badge bg-' + (msg.from_id === CURRENT_USER_ID ? 'primary' : 'secondary');
            span.textContent = msg.text;

            div.appendChild(span);
            messagesDiv.appendChild(div);
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>

</html>